%% WhatsApp Sales Bot Architecture Diagram
%% Copy this entire content to https://www.mermaidchart.com/

graph TB
    subgraph "ðŸŒ External Systems"
        META[Meta/WhatsApp] 
        GHL[GoHighLevel API]
        CAL[Calendar System]
    end

    subgraph "ðŸ“¥ Webhook Layer"
        META -->|webhook| EP["/webhook/meta-lead"]
        EP --> API["<b>langgraph-api.js</b><br/>â€¢ Request validation<br/>â€¢ Deduplication (MD5)<br/>â€¢ Request locking"]
        API -->|duplicate?| DUP{Check Hash}
        DUP -->|exists| SKIP[Return 200 - Skip]
        DUP -->|new| HANDLER
    end

    subgraph "ðŸ§  Message Processing"
        HANDLER["<b>webhookHandler.js</b><br/>â€¢ Initialize services<br/>â€¢ Process webhook<br/>â€¢ Clear cache"]
        HANDLER --> CM["<b>ConversationManager</b><br/>â€¢ Fetch history from GHL<br/>â€¢ Filter tool responses<br/>â€¢ Build state"]
        CM <--> GHL
        CM --> STATE[["<b>Conversation State</b><br/>ðŸ“‹ messages[]<br/>ðŸ‘¤ leadInfo<br/>ðŸ†” contactId<br/>ðŸ’¬ conversationId"]]
    end

    subgraph "ðŸ¤– Sales Agent Core"
        STATE --> AGENT["<b>salesAgent.js</b><br/>â€¢ createReactAgent<br/>â€¢ Custom state schema<br/>â€¢ Context-aware prompt"]
        
        AGENT --> TOOLS{Tool Selection}
        
        subgraph "ðŸ”§ Agent Tools"
            T1["<b>extractLeadInfo</b><br/>â€¢ getCurrentTaskInput()<br/>â€¢ Merge with existing<br/>â€¢ Return full context"]
            T2["<b>sendGHLMessage</b><br/>â€¢ WhatsApp delivery<br/>â€¢ Response tracking"]
            T3["<b>updateGHLContact</b><br/>â€¢ Tags & custom fields<br/>â€¢ Notes timeline<br/>â€¢ Lead status"]
            T4["<b>getCalendarSlots</b><br/>â€¢ Validate qualification<br/>â€¢ Fetch availability<br/>â€¢ Format slots"]
            T5["<b>bookAppointment</b><br/>â€¢ Parse selection<br/>â€¢ Create booking<br/>â€¢ Send confirmation"]
        end
        
        TOOLS -->|extract| T1
        TOOLS -->|respond| T2
        TOOLS -->|update| T3
        TOOLS -->|calendar| T4
        TOOLS -->|book| T5
        
        T1 -.->|updates| STATE
        T2 --> GHL
        T3 --> GHL
        T4 <--> CAL
        T5 --> CAL
    end

    subgraph "ðŸ“Š 7-Step Qualification Flow"
        direction LR
        S1[1ï¸âƒ£ Greeting]
        S2[2ï¸âƒ£ Name]
        S3[3ï¸âƒ£ Problem]
        S4[4ï¸âƒ£ Goal]
        S5[5ï¸âƒ£ Budget]
        S6[6ï¸âƒ£ Email]
        S7[7ï¸âƒ£ Booking]
        
        S1 -->|"Hola"| S2
        S2 -->|"Soy Jaime"| S3
        S3 -->|"Necesito clientes"| S4
        S4 -->|"Aumentar 50%"| S5
        S5 -->|">=$300"| S6
        S5 -.->|"<$300"| NURTURE[Nurture Lead]
        S6 -->|"email@dom"| S7
        S7 -->|"Martes 11am"| DONE[âœ… Booked]
    end

    subgraph "ðŸ’¾ Data Updates"
        UPDATE_DATA["<b>GHL Updates</b><br/>â€¢ Tags: qualified-lead, budget-300-plus<br/>â€¢ Fields: name, budget, goal, business_type<br/>â€¢ Notes: [timestamp] conversation progress"]
    end

    T3 --> UPDATE_DATA
    UPDATE_DATA --> GHL

    classDef external fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef processing fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef agent fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef tool fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef flow fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef data fill:#f1f8e9,stroke:#689f38,stroke-width:2px

    class META,GHL,CAL external
    class EP,API,HANDLER,CM processing
    class AGENT,STATE agent
    class T1,T2,T3,T4,T5 tool
    class S1,S2,S3,S4,S5,S6,S7 flow
    class UPDATE_DATA data